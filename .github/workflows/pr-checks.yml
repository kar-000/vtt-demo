name: PR Quality Gates

on:
  pull_request:
    branches: [master, main]
    types: [opened, synchronize, reopened]

# Ensure only one PR check runs at a time per PR
concurrency:
  group: pr-${{ github.head_ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # BACKEND COVERAGE ENFORCEMENT
  # ============================================================================
  backend-coverage:
    name: Backend Coverage (90% minimum)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for diff

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage
        working-directory: ./backend
        run: |
          # Run tests with coverage (overall project coverage is tracked but not enforced here)
          # 90% enforcement is done per-file for new/changed code in changed-files-coverage job
          python -m pytest tests/ \
            --cov=app \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --cov-report=term-missing \
            -v

      - name: Generate coverage report
        if: always()
        working-directory: ./backend
        run: |
          python -m coverage report --show-missing

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/htmlcov/

      - name: Coverage comment on PR
        if: always()
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
          MINIMUM_GREEN: 90
          MINIMUM_ORANGE: 75
          COVERAGE_PATH: backend/coverage.xml

  # ============================================================================
  # CHANGED FILES COVERAGE CHECK (90% minimum for new code)
  # ============================================================================
  changed-files-coverage:
    name: New Code Coverage (90% minimum)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed Python files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            backend/app/**/*.py

      - name: Set up Python
        if: steps.changed-files.outputs.any_changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check coverage on changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        working-directory: ./backend
        run: |
          echo "Changed files: ${{ steps.changed-files.outputs.all_changed_files }}"

          # Run coverage for all tests
          python -m pytest tests/ \
            --cov=app \
            --cov-report=xml:coverage.xml \
            -v

          # Check coverage percentage for each changed file
          echo "Checking coverage for changed files..."
          FAILED=false

          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            # Strip backend/ prefix for coverage check
            rel_path=${file#backend/}

            # Get coverage for this file
            coverage=$(python -m coverage report --include="$rel_path" 2>/dev/null | tail -1 | awk '{print $NF}' | tr -d '%')

            if [ -n "$coverage" ] && [ "$coverage" != "TOTAL" ]; then
              echo "Coverage for $rel_path: ${coverage}%"

              # Check if below 90%
              if [ $(echo "$coverage < 90" | bc -l) -eq 1 ]; then
                echo "::error file=$file::Coverage for $rel_path is ${coverage}%, which is below the 90% minimum"
                FAILED=true
              fi
            fi
          done

          if [ "$FAILED" = true ]; then
            echo "::error::Some changed files have coverage below 90%"
            exit 1
          fi

          echo "All changed files meet the 90% coverage requirement!"

  # ============================================================================
  # SECURITY CHECKS
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit security scan
        working-directory: ./backend
        run: |
          bandit -r app/ -ll -ii -x tests/ --format json --output bandit-report.json || true
          bandit -r app/ -ll -ii -x tests/

      - name: Check for known vulnerabilities
        working-directory: ./backend
        run: |
          safety check -r requirements.txt --full-report || echo "::warning::Some dependencies have known vulnerabilities"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: backend/bandit-report.json

  # ============================================================================
  # ALL TESTS MUST PASS
  # ============================================================================
  all-tests:
    name: All Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run all backend tests
        working-directory: ./backend
        run: |
          python -m pytest tests/ -v --tb=long

  # ============================================================================
  # FINAL STATUS CHECK
  # ============================================================================
  pr-status:
    name: PR Status
    runs-on: ubuntu-latest
    needs: [backend-coverage, changed-files-coverage, security-scan, all-tests]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.backend-coverage.result }}" != "success" ]; then
            echo "::error::Backend coverage report failed"
            exit 1
          fi
          if [ "${{ needs.changed-files-coverage.result }}" != "success" ]; then
            echo "::error::New code coverage check failed - new features must have 90%+ coverage"
            exit 1
          fi
          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "::error::Security scan failed"
            exit 1
          fi
          if [ "${{ needs.all-tests.result }}" != "success" ]; then
            echo "::error::Tests failed"
            exit 1
          fi
          echo "All PR checks passed!"
